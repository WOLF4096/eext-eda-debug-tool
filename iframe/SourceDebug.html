<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>源码追加 Debug 工具</title>
    <style>
        /* --- 基础样式 --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #202020; color: #d4d4d4;
        }
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background-color: #424242; border-radius: 6px; border: 3px solid #1e1e1e; }
        .container { display: flex; flex-direction: column; height: 100%; width: 100%; box-sizing: border-box; padding: 10px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; height: 40px; flex-shrink: 0; margin-bottom: 5px; }
        h2 { font-size: 16px; margin: 0; color: #4ec9b0; }
        .btn-group { display: flex; gap: 10px; }
        button { color: white; border: none; padding: 5px 15px; cursor: pointer; font-size: 14px; border-radius: 3px; transition: background-color 0.2s; }
        #btnImport { background-color: #0e639c; }
        #btnImport:hover { background-color: #1177bb; }
        #btnImport:disabled { background-color: #555; cursor: not-allowed; }
        #btnCopy { background-color: #3a3d41; border: 1px solid #454545; }
        .label-text { font-size: 12px; color: #888; margin-bottom: 3px; flex-shrink: 0; }
        textarea { width: 100%; background-color: #252526; color: #d4d4d4; border: 1px solid #3c3c3c; outline: none; padding: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; flex: 1; white-space: pre; overflow: auto; resize: none; }
        textarea:focus { border-color: #007acc; }
        #sourceInput { margin-bottom: 10px; }
        #errorOutput { color: #f48771; background-color: #2d2020; }
    </style>
</head>
<body>

<div class="container">
    <div class="toolbar">
        <h2 id="versionTitle">源码追加 Debug 工具</h2>
        <div class="btn-group">
            <button id="btnImport" onclick="startAppendProcess()">开始追加更新</button>
            <button id="btnCopy" onclick="copyErrorLog()" title="复制下方错误框的内容">复制错误信息</button>
        </div>
    </div>

    <div class="label-text">输入要追加的代码:</div>
    <textarea id="sourceInput" placeholder="在此粘贴需要追加的图元源码..."></textarea>

    <div class="label-text" style="margin-top: 10px;">处理结果:</div>
    <textarea id="errorOutput" placeholder="结果将显示在这里..." readonly></textarea>
</div>

<script>
    const elSourceInput = document.getElementById('sourceInput');
    const elErrorOutput = document.getElementById('errorOutput');
    const elBtn = document.getElementById('btnImport');
    const elBtnCopy = document.getElementById('btnCopy');

    async function copyErrorLog() {
        const content = elErrorOutput.value;
        if (!content) {
            eda.sys_Message.showToastMessage("没有可复制的内容","info");
            return;
        }
        try {
            await navigator.clipboard.writeText(content);
            showCopyFeedback();
        } catch (err) {
            elErrorOutput.select();
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            elErrorOutput.blur(); 
            showCopyFeedback();
        }
    }

    function showCopyFeedback() {
        const originalText = elBtnCopy.innerText;
        elBtnCopy.innerText = "已复制剪贴板";
        elBtnCopy.style.backgroundColor = "#2da042";
        setTimeout(() => {
            elBtnCopy.innerText = originalText;
            elBtnCopy.style.backgroundColor = "";
        }, 1500);
    }

    // --- 主处理逻辑 ---
    async function startAppendProcess() {
        const inputCode = elSourceInput.value.trim();
        if (!inputCode) {
            eda.sys_Message.showToastMessage("请先输入要追加的代码！","info");
            return;
        }

        elErrorOutput.value = "";
        elErrorOutput.style.color = "#f48771"; 
        elBtn.disabled = true;
        
        let errorCount = 0; 

        try {
            // 1. 获取客户端版本
            const version = await eda.sys_Environment.getEditorCurrentVersion();
            const isV3 = version.startsWith('3.');

            // 2. 获取原始源码
            let currentBaseSource = await eda.sys_FileManager.getDocumentSource();
            
            // 3. 处理 V3 基础源码末尾补齐管道符
            if (isV3 && currentBaseSource && !currentBaseSource.endsWith('|')) {
                currentBaseSource += "|";
            }

            const linesToAppend = inputCode.split(/\r?\n/).filter(l => l.trim() !== "");
            let resultLog = "";

            for (let i = 0; i < linesToAppend.length; i++) {
                let line = linesToAppend[i].trim();
                elBtn.innerText = `处理中 ${i + 1}/${linesToAppend.length}`;

                let candidateSource = "";

                if (isV3) {
                    // V3 逻辑：
                    // 去掉待追加行末尾的 |
                    if (line.endsWith('|')) {
                        line = line.slice(0, -1);
                    }
                    // 拼接：旧源码(已有|) + \n + 新行
                    candidateSource = currentBaseSource + "\n" + line;
                } else {
                    // V2 逻辑：原样换行追加
                    const separator = currentBaseSource.endsWith('\n') ? "" : "\n";
                    candidateSource = currentBaseSource + separator + line;
                }

                const isSuccess = await eda.sys_FileManager.setDocumentSource(candidateSource);

                if (isSuccess) {
                    currentBaseSource = candidateSource;
                    // V3 写入成功后，为下一次循环补齐末尾 |（因为 V3 setDocumentSource 成功后获取的可能又不带 |）
                    if (isV3 && !currentBaseSource.endsWith('|')) {
                        currentBaseSource += "|";
                    }
                } else {
                    errorCount++;
                    resultLog += line + "\n";
                    elErrorOutput.value = resultLog;
                    elErrorOutput.scrollTop = elErrorOutput.scrollHeight;
                }
            }

            if (errorCount === 0) {
                elErrorOutput.style.color = "#4ec9b0"; 
                elErrorOutput.value = "蒸蚌！全部追加成功！";
            } else {
                elErrorOutput.style.color = "#f48771";
                elErrorOutput.value += `\n萝卜！萝卜！萝卜！`;
            }

        } catch (err) {
            console.error(err);
            elErrorOutput.value += `\n[系统错误]: ${err.message}`;
        } finally {
            elBtn.disabled = false;
            elBtn.innerText = "开始追加更新";
        }
    }
</script>
</body>
</html>
